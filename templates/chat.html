<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>
    <div class="container">
        <h2>Chat</h2>

        <!-- Выпадающий список для выбора пользователя -->
        <select id="userSelect">
            <option value="" disabled selected>Select a user to chat with</option>
        </select>

        <div id="messages"></div>
        <textarea id="messageInput" placeholder="Type your message"></textarea>
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        // Загружаем список пользователей
        function loadUsers() {
            fetch("/get_users")
                .then(response => response.json())
                .then(users => {
                    const userSelect = document.getElementById("userSelect");
                    users.forEach(user => {
                        const option = document.createElement("option");
                        option.value = user.id;
                        option.textContent = user.username;
                        userSelect.appendChild(option);
                    });
                });
        }

        // Отправка сообщения выбранному пользователю
        function sendMessage() {
            const messageContent = document.getElementById("messageInput").value;
            const receiverId = document.getElementById("userSelect").value;

            if (!receiverId) {
                alert("Please select a user to chat with.");
                return;
            }

            fetch("/send_message", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ content: messageContent, receiver_id: receiverId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    loadMessages(receiverId);
                    document.getElementById("messageInput").value = "";  // Очистить поле ввода
                }
            });
        }

        // Загрузка сообщений с выбранным пользователем
        function loadMessages(receiverId) {
            fetch(`/get_messages?receiver_id=${receiverId}`)
                .then(response => response.json())
                .then(messages => {
                    const messagesContainer = document.getElementById("messages");
                    messagesContainer.innerHTML = "";  // Очистить старые сообщения
                    messages.forEach(msg => {
                        const messageElement = document.createElement("p");
                        messageElement.textContent = `${msg.sender}: ${msg.content}`;
                        messageElement.className = msg.sender === "{{ session['username'] }}" ? 'message sent' : 'message received';
                        messagesContainer.appendChild(messageElement);
                    });
                });
        }

        // Автоматическое обновление сообщений каждые 3 секунды для выбранного пользователя
        setInterval(() => {
            const receiverId = document.getElementById("userSelect").value;
            if (receiverId) {
                loadMessages(receiverId);
            }
        }, 3000);

        // Загрузка списка пользователей при загрузке страницы
        document.addEventListener("DOMContentLoaded", loadUsers);
    </script>
</body>
</html>
